<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kingreganaire Ref</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background: #4a148c;
      color: white;
      padding: 20px;
    }
    main {
      padding: 30px;
    }
    .btn {
      background: #6a1b9a;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 18px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn:hover {
      background: #7b1fa2;
    }
    .card {
      background: white;
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    input, select, textarea {
      padding: 10px;
      width: 90%;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    #dashboard, #adminPanel {
      display: none;
    }
    footer {
      background: #4a148c;
      color: white;
      padding: 15px;
      margin-top: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px auto;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 14px;
    }
    th {
      background: #eee;
    }
  </style>
</head>
<body>
  <header>
    <h1>Karibu Kingreganaire Ref</h1>
    <p>Jiunge kwa Tsh 5,000 na uanze kupata faida kwa referral!</p>
  </header>
  <main>
    <div class="card" id="auth">
      <h2>Login / Signup</h2>
      <form id="authForm">
        <input type="text" id="username" placeholder="Jina Kamili" required><br>
        <input type="tel" id="userphone" placeholder="Namba ya Simu" required><br>
        <button type="submit" class="btn">Ingia</button>
      </form>
    </div><div class="card" id="dashboard">
  <h2>Dashboard ya Mtumiaji</h2>
  <p><strong>Jina:</strong> <span id="dashName"></span></p>
  <p><strong>Namba ya Simu:</strong> <span id="dashPhone"></span></p>
  <p><strong>Referral Link:</strong></p>
  <p><code id="refLink"></code></p>
  <h3>Omba Malipo</h3>
  <form id="withdrawForm">
    <input type="number" id="amount" placeholder="Kiasi unachotaka kutoa (Tsh)" required><br>
    <input type="text" id="mpesa" placeholder="Namba ya M-Pesa ya kupokea" required><br>
    <button type="submit" class="btn">Omba Malipo</button>
  </form>
  <p id="withdrawMessage"></p>
  <button onclick="logout()" class="btn">Toka</button>
</div>

<div class="card" id="adminLogin">
  <h2>Admin Access</h2>
  <input type="password" id="adminCode" placeholder="Weka admin code">
  <button class="btn" onclick="checkAdminCode()">Ingia Admin</button>
</div>

<div class="card" id="adminPanel">
  <h2>Admin Panel</h2>
  <input type="text" id="searchInput" placeholder="Tafuta jina/simu/link">
  <h3>Users</h3>
  <table id="usersTable"><thead><tr><th>Jina</th><th>Simu</th><th>Referral Link</th></tr></thead><tbody></tbody></table>
  <h3>Withdrawals</h3>
  <table id="withdrawalsTable"><thead><tr><th>Jina</th><th>Simu</th><th>Kiasi</th><th>M-Pesa</th><th>Tendaji</th></tr></thead><tbody></tbody></table>
</div>

  </main>
  <footer>
    <p>Â© 2025 Kingregan. Haki zote zimehifadhiwa.</p>
  </footer>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAwnI3Sezv6SQKQ6nUgLv48IVZGG9Jq5AE",
      authDomain: "kingreganaire-ref.firebaseapp.com",
      projectId: "kingreganaire-ref",
      storageBucket: "kingreganaire-ref.firebasestorage.app",
      messagingSenderId: "121481840174",
      appId: "1:121481840174:web:dd4a61e7c28b2602c341bf",
      measurementId: "G-BMX502JQHL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const authForm = document.getElementById("authForm");
    const authDiv = document.getElementById("auth");
    const dashDiv = document.getElementById("dashboard");
    const dashName = document.getElementById("dashName");
    const dashPhone = document.getElementById("dashPhone");
    const refLink = document.getElementById("refLink");
    const withdrawForm = document.getElementById("withdrawForm");
    const withdrawMessage = document.getElementById("withdrawMessage");

    authForm.addEventListener("submit", async function(e) {
      e.preventDefault();
      const name = document.getElementById("username").value;
      const phone = document.getElementById("userphone").value;
      localStorage.setItem("name", name);
      localStorage.setItem("phone", phone);
      dashName.textContent = name;
      dashPhone.textContent = phone;
      refLink.textContent = `https://kingregan.github.io/kingreganaire/?ref=${phone}`;
      authDiv.style.display = "none";
      dashDiv.style.display = "block";
      try {
        await addDoc(collection(db, "users"), {
          name: name,
          phone: phone,
          ref: refLink.textContent,
          createdAt: new Date()
        });
      } catch (error) {
        console.error("Error adding user:", error);
      }
    });

    withdrawForm.addEventListener("submit", async function(e) {
      e.preventDefault();
      const amount = document.getElementById("amount").value;
      const mpesa = document.getElementById("mpesa").value;
      const name = localStorage.getItem("name");
      const phone = localStorage.getItem("phone");
      try {
        await addDoc(collection(db, "withdrawals"), {
          name: name,
          phone: phone,
          amount: amount,
          mpesa: mpesa,
          requestedAt: new Date()
        });
        withdrawMessage.textContent = `Ombi la malipo ya Tsh ${amount} limetumwa. Malipo yatatumwa kwa namba ${mpesa}.`;
        withdrawForm.reset();
      } catch (error) {
        console.error("Error adding withdrawal:", error);
        withdrawMessage.textContent = "Tatizo limetokea. Tafadhali jaribu tena.";
      }
    });

    function logout() {
      localStorage.clear();
      dashDiv.style.display = "none";
      authDiv.style.display = "block";
    }

    window.onload = function () {
      const name = localStorage.getItem("name");
      const phone = localStorage.getItem("phone");
      if (name && phone) {
        dashName.textContent = name;
        dashPhone.textContent = phone;
        refLink.textContent = `https://kingregan.github.io/kingreganaire/?ref=${phone}`;
        authDiv.style.display = "none";
        dashDiv.style.display = "block";
      }
    }

    window.checkAdminCode = async function () {
      const code = document.getElementById("adminCode").value;
      if (code === "9523king") {
        document.getElementById("adminLogin").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";

        const usersSnap = await getDocs(collection(db, "users"));
        const usersTable = document.querySelector("#usersTable tbody");
        usersSnap.forEach(doc => {
          const d = doc.data();
          usersTable.innerHTML += `<tr><td>${d.name}</td><td>${d.phone}</td><td>${d.ref}</td></tr>`;
        });

        const withdrawSnap = await getDocs(collection(db, "withdrawals"));
        const withdrawalsTable = document.querySelector("#withdrawalsTable tbody");
        withdrawSnap.forEach(docSnap => {
          const d = docSnap.data();
          withdrawalsTable.innerHTML += `<tr><td>${d.name}</td><td>${d.phone}</td><td>${d.amount}</td><td>${d.mpesa}</td><td><button class='btn' onclick='markAsPaid("${docSnap.id}", "${d.name}", "${d.phone}")'>Mark as Paid</button></td></tr>`;
        });
      } else {
        alert("Code si sahihi!");
      }
    };

    window.markAsPaid = async function (id, name, phone) {
      const withdrawalRef = doc(db, "withdrawals", id);
      await updateDoc(withdrawalRef, { status: "paid" });
      alert(`Malipo ya ${name} yametiwa alama kama yamelipwa.`);
      location.reload();
    };

    document.getElementById("searchInput").addEventListener("keyup", function () {
      const filter = this.value.toLowerCase();
      document.querySelectorAll("table tbody tr").forEach(row => {
        row.style.display = [...row.cells].some(td => td.innerText.toLowerCase().includes(filter)) ? "" : "none";
      });
    });
  </script></body>
</html>
