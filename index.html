
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KINGREGANAIRE REFFERAL EARNINGðŸ’°</title>
  <style>
    /* styles simplified for clarity */
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .card {
      background: white;
      max-width: 400px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    input[type=text], input[type=email], input[type=tel], input[type=password] {
      width: 100%;
      padding: 8px;
      margin: 8px 0 12px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button.btn {
      width: 100%;
      background-color: #6a1b9a;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    button.btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .password-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    .link {
      color: #6a1b9a;
      cursor: pointer;
      text-decoration: underline;
      margin-top: 10px;
      display: block;
      text-align: center;
    }
    .link:hover {
      color: #4a148c;
    }
    #successMsg {
      color: green;
      text-align: center;
      margin-top: 12px;
      display: none;
    }
    #loaderSignup, #loaderLogin {
      text-align: center;
      margin: 10px 0;
      display: none;
    }
  </style>
</head>
<body>

  <div class="card" id="auth">
    <h2>Signup</h2>
    <input type="text" id="name" placeholder="Jina Kamili" />
    <input type="email" id="email" placeholder="Email" />
    <input type="tel" id="phone" placeholder="Namba ya Simu" />
    <input type="text" id="nida" placeholder="Namba ya NIDA" />
    <input type="text" id="region" placeholder="Mkoa" />
    <input type="text" id="district" placeholder="Wilaya" />
    <input type="password" id="password" placeholder="Neno la Siri" />
    <input type="password" id="confirmPassword" placeholder="Thibitisha Neno la Siri" />
    <div class="password-toggle">
      <input type="checkbox" id="togglePassword" />
      <label for="togglePassword">Onyesha Neno la Siri</label>
    </div>
    <button class="btn" onclick="signup()">Jisajili</button>
    <div id="loaderSignup">Inasajili...</div>
    <div id="successMsg">âœ… Usajili umefanikiwa! Tafadhali fanya login sasa.</div>

    <hr />

    <h2>Login</h2>
    <input type="tel" id="loginPhone" placeholder="Namba ya Simu" />
    <input type="password" id="loginPassword" placeholder="Neno la Siri" />
    <div class="password-toggle">
      <input type="checkbox" id="toggleLoginPassword" />
      <label for="toggleLoginPassword">Onyesha Neno la Siri</label>
    </div>
    <button class="btn" onclick="login()">Login</button>
    <div id="loaderLogin">Inaanza Kuingia...</div>
    <span class="link" onclick="showResetPassword()">Umesahau Neno la Siri?</span>
  </div>

  <div class="card" id="resetPasswordCard" style="display:none">
    <h2>Badili Neno la Siri</h2>
    <input type="tel" id="resetPhone" placeholder="Namba ya Simu" />
    <input type="password" id="newPassword" placeholder="Neno Jipya" />
    <input type="password" id="confirmNewPassword" placeholder="Thibitisha Neno Jipya" />
    <button class="btn" onclick="resetPassword()">Wasilisha</button>
    <span class="link" onclick="backToLogin()">Rudi kwenye Login</span>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs, query, where, addDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAwnI3Sezv6SQKQ6nUgLv48IVZGG9Jq5AE",
    authDomain: "kingreganaire-ref.firebaseapp.com",
    projectId: "kingreganaire-ref",
    storageBucket: "kingreganaire-ref.firebasestorage.app",
    messagingSenderId: "121481840174",
    appId: "1:121481840174:web:dd4a61e7c28b2602c341bf",
    measurementId: "G-BMX502JQHL"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const functions = getFunctions(app);

  const loaderSignup = document.getElementById("loaderSignup");
  const successMsg = document.getElementById("successMsg");
  const loaderLogin = document.getElementById("loaderLogin");

  window.signup = async function () {
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const nida = document.getElementById("nida").value.trim();
    const region = document.getElementById("region").value.trim();
    const district = document.getElementById("district").value.trim();
    const password = document.getElementById("password").value.trim();
    const confirmPassword = document.getElementById("confirmPassword").value.trim();

    if (!name || !email || !phone || !nida || !region || !district || !password || !confirmPassword) {
      alert("Tafadhali jaza taarifa zote za usajili.");
      return;
    }
    if (password !== confirmPassword) {
      alert("Neno la siri na uthibitisho wake havilingani.");
      return;
    }

    loaderSignup.style.display = "block";
    successMsg.style.display = "none";
    document.querySelector("#auth button").disabled = true;

    try {
      await addDoc(collection(db, "users"), {
        name, email, phone, nida, region, district, password, paid: false
      });
      setTimeout(() => {
        loaderSignup.style.display = "none";
        successMsg.style.display = "block";
        document.querySelector("#auth button").disabled = false;
      }, 1000);
    } catch (err) {
      alert("Tatizo limetokea, jaribu tena.");
      loaderSignup.style.display = "none";
      document.querySelector("#auth button").disabled = false;
    }
  };

  window.showResetPassword = function () {
    document.getElementById("auth").style.display = "none";
    document.getElementById("resetPasswordCard").style.display = "block";
  };

  window.backToLogin = function () {
    document.getElementById("resetPasswordCard").style.display = "none";
    document.getElementById("auth").style.display = "block";
  };

  window.resetPassword = async function () {
    const phone = document.getElementById("resetPhone").value.trim();
    const newPassword = document.getElementById("newPassword").value.trim();
    const confirmNewPassword = document.getElementById("confirmNewPassword").value.trim();

    if (!phone || !newPassword || !confirmNewPassword) {
      alert("Tafadhali jaza sehemu zote.");
      return;
    }
    if (newPassword !== confirmNewPassword) {
      alert("Neno jipya na uthibitisho havilingani.");
      return;
    }

    try {
      const q = query(collection(db, "users"), where("phone", "==", phone));
      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) {
        alert("Mtumiaji hakupatikana.");
        return;
      }
      // Update password
      for (const docSnap of querySnapshot.docs) {
        await updateDoc(doc(db, "users", docSnap.id), { password: newPassword });
      }

      // Call Firebase function to send email notification
      const sendEmail = httpsCallable(functions, "sendPasswordResetEmail");
      await sendEmail({ phone });

      alert("Neno la siri limebadilishwa kwa mafanikio na email imetumwa.");
      backToLogin();
    } catch (err) {
      console.error(err);
      alert("Tatizo limetokea, jaribu tena.");
    }
  };

  document.getElementById("togglePassword").addEventListener("change", function () {
    const passwordInput = document.getElementById("password");
    const confirmInput = document.getElementById("confirmPassword");
    const type = this.checked ? "text" : "password";
    passwordInput.type = type;
    confirmInput.type = type;
  });

  document.getElementById("toggleLoginPassword").addEventListener("change", function () {
    const loginInput = document.getElementById("loginPassword");
    loginInput.type = this.checked ? "text" : "password";
  });

  window.login = async function () {
    const phone = document.getElementById("loginPhone").value.trim();
    const password = document.getElementById("loginPassword").value.trim();

    if (!phone || !password) {
      alert("Tafadhali jaza namba ya simu na neno la siri.");
      return;
    }

    loaderLogin.style.display = "block";
    try {
      const q = query(collection(db, "users"), where("phone", "==", phone), where("password", "==", password));
      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) {
        alert("Namba au neno la siri si sahihi.");
      } else {
        alert("Umeingia kwa mafanikio!");
        // TODO: Endesha dashboard au kurasa za app hapa
      }
    } catch (err) {
      alert("Tatizo limetokea, jaribu tena.");
    } finally {
      loaderLogin.style.display = "none";
    }
  };
</script>

</body>
</html>
